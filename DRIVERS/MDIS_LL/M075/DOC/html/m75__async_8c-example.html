<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - M75 MDIS Driver - Example Documentation</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;"></a>
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">M75 MDIS Driver &nbsp; </h1>
	<h3>Example Documentation</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>m75_async.c</h1>Simple example for driver usage in asynchronous mode <div class="fragment"><pre><span class="comment">/****************************************************************************</span>
<span class="comment"> ************                                                    ************</span>
<span class="comment"> ************                   M75_ASYNC                        ************</span>
<span class="comment"> ************                                                    ************</span>
<span class="comment"> ****************************************************************************/</span>
 <span class="comment">/*-------------------------------[ History ]--------------------------------</span>
<span class="comment"> *</span>
<span class="comment"> * $Log: m75_async.c,v $</span>
<span class="comment"> * Revision 1.1  2009/07/14 17:47:20  cs</span>
<span class="comment"> * Initial Revision</span>
<span class="comment"> *</span>
<span class="comment"> *</span>
<span class="comment"> *---------------------------------------------------------------------------</span>
<span class="comment"> * (c) Copyright 2009 by MEN Mikro Elektronik GmbH, Nuremberg, Germany</span>
<span class="comment"> ****************************************************************************/</span>

<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> RCSid[]=<span class="stringliteral">"$Id: m75_async.c,v 1.1 2009/07/14 17:47:20 cs Exp $"</span>;

<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/men_typs.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/mdis_api.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/usr_oss.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/mdis_err.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="m75__drv_8h.html">MEN/m75_drv.h</a>&gt;</span>

<span class="comment">/*--------------------------------------+</span>
<span class="comment">|   DEFINES                             |</span>
<span class="comment">+--------------------------------------*/</span>
<span class="comment">/* none */</span>
<span class="preprocessor">#define EXT_FIFO_SIZE 0x800</span>
<span class="preprocessor"></span><span class="comment">/*--------------------------------------+</span>
<span class="comment">|   TYPDEFS                             |</span>
<span class="comment">+--------------------------------------*/</span>
<span class="comment">/* none */</span>

<span class="comment">/*--------------------------------------+</span>
<span class="comment">|   EXTERNALS                           |</span>
<span class="comment">+--------------------------------------*/</span>
<span class="comment">/* none */</span>

<span class="comment">/*--------------------------------------+</span>
<span class="comment">|   GLOBALS                             |</span>
<span class="comment">+--------------------------------------*/</span>
<span class="comment">/* none */</span>

<span class="comment">/*--------------------------------------+</span>
<span class="comment">|   PROTOTYPES                          |</span>
<span class="comment">+--------------------------------------*/</span>
<span class="keyword">static</span> MDIS_PATH <a name="a0"></a><a class="code" href="m75__async_8c.html#a2">setupChannel</a>(<span class="keywordtype">char</span>* dev, int32 chan, int32 tconst);
<span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a1"></a><a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="keywordtype">char</span> *info);


<span class="comment">/********************************* main ************************************/</span>
<span class="keywordtype">int</span> <a class="code" href="m75__simp_8c.html#a3">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
    MDIS_PATH path1 = -1 , path2 = -1;
    int32   chan1, chan2,
            tconst,
            nbrOfBytesSent,
            nbrOfBytesReceived=0,
            i, n=0, fSize = 0x10, got_data=0, loops = 1,
            error=0, syserror = 0, ckerror = 0;
            <span class="comment">/* syserror=0, */</span>
    <span class="keywordtype">char</span>    *dev1, *dev2, *errstr;
    u_int8  txBuffer[EXT_FIFO_SIZE],
            rxBuffer[EXT_FIFO_SIZE],
            *bufp=txBuffer;

    <span class="keywordflow">if</span> (argc &lt; 6 || strcmp(argv[1],<span class="stringliteral">"-?"</span>)==0) {
        printf(<span class="stringliteral">"\n"</span>);
        printf(<span class="stringliteral">"Syntax: m75_simp &lt;device1&gt; &lt;chan1&gt; &lt;device2&gt; &lt;chan2&gt; &lt;tconst&gt; &lt;loops&gt;\n"</span>);
        printf(<span class="stringliteral">"Function:\n"</span>);
        printf(<span class="stringliteral">"  M75 example for receiving/transmitting in asynchronous mode\n"</span>);
        printf(<span class="stringliteral">"Options:\n"</span>);
        printf(<span class="stringliteral">"    deviceX       device name\n"</span>);
        printf(<span class="stringliteral">"    chanX         channel number (0..n)\n"</span>);
        printf(<span class="stringliteral">"    tconst        BR Gen timeconstant (hex)\n"</span>);
        printf(<span class="stringliteral">"    loops         numbers of packets to Xfer\n"</span>);
        printf(<span class="stringliteral">"\n%s\n"</span>, RCSid);
        <span class="keywordflow">return</span>(1);
    }

    dev1    = argv[1];
    chan1   = atoi(argv[2]);
    dev2    = argv[3];
    chan2   = atoi(argv[4]);

    tconst = strtol(argv[5], &amp;errstr, 16);
    loops  = atoi(argv[6]);

    printf(<span class="stringliteral">"%s:%d &lt;-&gt; %s:%d\t0x%X\n"</span>,dev1, chan1, dev2, chan2, tconst);


    <span class="comment">/*------------------------------+</span>
<span class="comment">    |  open path and config device  |</span>
<span class="comment">    +------------------------------*/</span>
    <span class="keywordflow">if</span>( (path1 = <a class="code" href="m75__async_8c.html#a2">setupChannel</a>( dev1, chan1, tconst)) &lt; 0 ) {
        <span class="keywordflow">goto</span> ABORT;
    }
    <span class="keywordflow">if</span>( (path2 = <a class="code" href="m75__async_8c.html#a2">setupChannel</a>( dev2, chan2, tconst)) &lt; 0 ) {
        <span class="keywordflow">goto</span> ABORT;
    }

    <span class="keywordflow">while</span>( n++ &lt; loops ) {
        <span class="comment">/* init Tx buffer */</span>
        bufp = txBuffer;
        <span class="keywordflow">if</span>( fSize &gt; EXT_FIFO_SIZE )
            fSize = 0x10;

        *bufp++ = (u_int8)n;
        <span class="keywordflow">for</span>(i=1; i&lt;fSize; i++) {
            *bufp++ = (u_int8)(i+n);
        }
        <span class="comment">/* send frame */</span>
        <span class="keywordflow">if</span>( (nbrOfBytesSent = M_setblock(path1,txBuffer,fSize)) != fSize ) {
            error++;
        }
        printf(<span class="stringliteral">"    M_setblock() \tnbrOfBytesSent=%d\n"</span>, nbrOfBytesSent);


        UOS_Delay( fSize*(6+(tconst&gt;&gt;3)) );

        <span class="comment">/* receive frame (sent bytes) */</span>
        <span class="keywordflow">while</span>( !error &amp;&amp; !got_data ){
            <span class="keywordflow">if</span>( (nbrOfBytesReceived = M_getblock(path2,rxBuffer,EXT_FIFO_SIZE)) != nbrOfBytesSent ) {
                syserror = UOS_ErrnoGet();
                printf(<span class="stringliteral">"*** %s ***\n"</span>,M_errstring( syserror ) );
                <span class="keywordflow">if</span>( syserror != ERR_SUCCESS ) {
                    error++;
                }
            } <span class="keywordflow">else</span> {
                got_data++;
            }
        }
        <span class="keywordflow">if</span>( got_data ) {
            printf(<span class="stringliteral">"        M_getblock() \tnbrOfBytesReceived=%d\n"</span>, nbrOfBytesReceived);

            <span class="comment">/* print data */</span>
            printf(<span class="stringliteral">"Received data:\n"</span>);
            <span class="keywordflow">for</span>(i=1; i &lt;= nbrOfBytesReceived; i++){
                printf(<span class="stringliteral">"\t0x%02X"</span>, *(rxBuffer+i-1));
                <span class="keywordflow">if</span>( (i!=0) &amp;&amp; !(i%8) )
                    printf(<span class="stringliteral">"\n"</span>);
            }
            printf(<span class="stringliteral">"\n"</span>);

            <span class="comment">/* check data */</span>
            <span class="keywordflow">if</span>( !error ){
                <span class="keywordflow">for</span>(i=0; i &lt; nbrOfBytesSent; i++){
                    <span class="keywordflow">if</span>( *(rxBuffer+i) != *(txBuffer+i) ) ckerror++;
                }
                <span class="keywordflow">if</span>( ckerror ) {
                    error++;
                    printf( <span class="stringliteral">"*** frames sent and received differ!!!\n\n\n"</span> );

                    printf(<span class="stringliteral">"   Sent data:\n"</span>);
                    <span class="keywordflow">for</span>(i=1; i &lt;= nbrOfBytesSent; i++){
                        printf(<span class="stringliteral">"\t0x%02X"</span>, *(txBuffer+i-1));
                        <span class="keywordflow">if</span>( (i!=0) &amp;&amp; !(i%8) )
                            printf(<span class="stringliteral">"\n"</span>);
                    }
                    printf(<span class="stringliteral">"\n"</span>);
                }
            } <span class="keywordflow">else</span> {
                printf(<span class="stringliteral">"*** data not beeing checked (error in Rx or Rx anyway)!\n"</span>);
            }
        } <span class="keywordflow">else</span> {
            printf(<span class="stringliteral">"*** NO (SUFFICIENT) DATA RECEIVED\n"</span>);
        }
        got_data = 0;
        fSize = fSize+7;

    }
    <span class="keywordflow">if</span>( !error )
        printf(<span class="stringliteral">"  ==&gt; OK Frame send/receive\n"</span>);
    <span class="keywordflow">else</span> {
        printf(<span class="stringliteral">"\nError: Send/Receive Frame\n"</span>
            <span class="stringliteral">"\tsent bytes: %04X\n\tread bytes: %04X\n"</span>,
            nbrOfBytesSent, nbrOfBytesReceived);
    }

    UOS_Delay(100);

    <span class="comment">/*--------------------+</span>
<span class="comment">    |  cleanup            |</span>
<span class="comment">    +--------------------*/</span>
ABORT:
    <span class="keywordflow">if</span> ( (path1 &gt;= 0) &amp;&amp; (M_close(path1) &lt; 0) )
        <a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="stringliteral">"close dev1"</span>);
    <span class="keywordflow">if</span> ( (path2 &gt;= 0) &amp;&amp; (M_close(path2) &lt; 0) )
        <a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="stringliteral">"close dev2"</span> );

    <span class="keywordflow">return</span>(0);
}

<span class="comment">/********************************* setupChannel ******************************/</span>
<span class="keyword">static</span> MDIS_PATH <a class="code" href="m75__async_8c.html#a2">setupChannel</a>(<span class="keywordtype">char</span>* dev, int32 chan, int32 tconst)
{
    MDIS_PATH path;
    <a name="_a2"></a><a class="code" href="structM75__SCC__REGS__PB.html">M75_SCC_REGS_PB</a> sccregs;
    M_SG_BLOCK msg_blk;

    <span class="comment">/*--------------------+</span>
<span class="comment">    |  open path          |</span>
<span class="comment">    +--------------------*/</span>
    <span class="keywordflow">if</span>( (path = M_open(dev)) &lt; 0 ) {
        <a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="stringliteral">"open device"</span>);
        <span class="keywordflow">return</span>(-1);
    }

    <span class="comment">/* channel number */</span>
    <span class="keywordflow">if</span>( M_setstat(path, M_MK_CH_CURRENT, chan) &lt; 0 ) {
        <a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="stringliteral">"M_setstat M_MK_CH_CURRENT"</span>);
        <span class="keywordflow">goto</span> ABORT;
    }

    <span class="comment">/*--------------------+</span>
<span class="comment">    |  send parameters    |</span>
<span class="comment">    +--------------------*/</span>
    <span class="comment">/* BR Gen Timeconstant, 16bit value */</span>
    <span class="comment">/* some example values for async (clock mode=16)</span>
<span class="comment">     *   Baudrate   |    Timeconstant</span>
<span class="comment">     *       156    |   0x707E</span>
<span class="comment">     *     9.600    |   0x002E</span>
<span class="comment">     *    16.000    |   0x0016</span>
<span class="comment">     *    38.400    |   0x000A</span>
<span class="comment">     *   115.200    |   0x0002</span>
<span class="comment">     *   230.400    |   0x0000</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span>( M_setstat( path, M75_BRGEN_TCONST, tconst ) &lt; 0 ) {
        <a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="stringliteral">"M_setstat M75_BRGEN_TCONST"</span>);
        <span class="keywordflow">goto</span> ABORT;
    }

    <span class="comment">/* enable IRQs */</span>
    <span class="keywordflow">if</span>( M_setstat( path, M_MK_IRQ_ENABLE, 0x01 ) &lt; 0 ) {   <span class="comment">/* enable global irq */</span>
        <a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="stringliteral">"M_setstat M75_BRGEN_TCONST"</span>);
        <span class="keywordflow">goto</span> ABORT;
    }
    <span class="keywordflow">if</span>( M_setstat( path, M75_IRQ_ENABLE, 0x01 ) &lt; 0 ) {    <span class="comment">/* enable channels irq */</span>
        <a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="stringliteral">"M_setstat M_MK_IRQ_ENABLE"</span>);
        <span class="keywordflow">goto</span> ABORT;
    }

    <span class="comment">/* Rx En */</span>
    <span class="keywordflow">if</span>( M_setstat( path, M75_RXEN, 1 ) &lt; 0 ) {
        <a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="stringliteral">"M_setstat M75_RXEN"</span>);
        <span class="keywordflow">goto</span> ABORT;
    }

    <span class="comment">/* Tx control */</span>
    <span class="keywordflow">if</span>( M_setstat( path, M75_SETBLOCK_TOUT, 0 ) &lt; 0 ) {
        <a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="stringliteral">"M_setstat M75_SETBLOCK_TOUT"</span>);
        <span class="keywordflow">goto</span> ABORT;
    }
    <span class="keywordflow">if</span>( M_setstat( path, M75_MAX_TXFRAME_NUM, 10 )  &lt; 0 ) {
        <a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="stringliteral">"M_setstat M75_MAX_TXFRAME_NUM"</span>);
        <span class="keywordflow">goto</span> ABORT;
    }
    <span class="keywordflow">if</span>( M_setstat( path, M75_MAX_TXFRAME_SIZE, EXT_FIFO_SIZE ) &lt; 0 ) {
        <a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="stringliteral">"M_setstat M75_MAX_TXFRAME_SIZE"</span>);
        <span class="keywordflow">goto</span> ABORT;
    }

    msg_blk.size = <span class="keyword">sizeof</span>(<a class="code" href="structM75__SCC__REGS__PB.html">M75_SCC_REGS_PB</a>);
    msg_blk.data = (<span class="keywordtype">void</span> *)&amp;sccregs;
    M_getstat(path, M75_SCC_REGS, (int32 *)&amp;msg_blk);
    printf( <span class="stringliteral">"    Current configuration of %s:%d:\n"</span>
            <span class="stringliteral">"        WR01 = 0x%02X    WR02 = 0x%02X    WR03 = 0x%02X\n"</span>
            <span class="stringliteral">"        WR04 = 0x%02X    WR05 = 0x%02X    WR06 = 0x%02X\n"</span>
            <span class="stringliteral">"        WR07 = 0x%02X    WR7p = 0x%02X    WR09 = 0x%02X\n"</span>
            <span class="stringliteral">"        WR10 = 0x%02X    WR11 = 0x%02X    WR12 = 0x%02X\n"</span>
            <span class="stringliteral">"        WR13 = 0x%02X    WR14 = 0x%02X    WR15 = 0x%02X\n\n"</span>,
            dev, chan,
            sccregs.<a name="a3"></a><a class="code" href="structM75__SCC__REGS__PB.html#o0">wr01</a>, sccregs.<a name="a4"></a><a class="code" href="structM75__SCC__REGS__PB.html#o1">wr02</a>, sccregs.<a name="a5"></a><a class="code" href="structM75__SCC__REGS__PB.html#o2">wr03</a>,
            sccregs.<a name="a6"></a><a class="code" href="structM75__SCC__REGS__PB.html#o3">wr04</a>, sccregs.<a name="a7"></a><a class="code" href="structM75__SCC__REGS__PB.html#o4">wr05</a>, sccregs.<a name="a8"></a><a class="code" href="structM75__SCC__REGS__PB.html#o5">wr06</a>,
            sccregs.<a name="a9"></a><a class="code" href="structM75__SCC__REGS__PB.html#o6">wr07</a>, sccregs.<a name="a10"></a><a class="code" href="structM75__SCC__REGS__PB.html#o7">wr7p</a>, sccregs.<a name="a11"></a><a class="code" href="structM75__SCC__REGS__PB.html#o8">wr09</a>,
            sccregs.<a name="a12"></a><a class="code" href="structM75__SCC__REGS__PB.html#o9">wr10</a>, sccregs.<a name="a13"></a><a class="code" href="structM75__SCC__REGS__PB.html#o10">wr11</a>, sccregs.<a name="a14"></a><a class="code" href="structM75__SCC__REGS__PB.html#o11">wr12</a>,
            sccregs.<a name="a15"></a><a class="code" href="structM75__SCC__REGS__PB.html#o12">wr13</a>, sccregs.<a name="a16"></a><a class="code" href="structM75__SCC__REGS__PB.html#o13">wr14</a>, sccregs.<a name="a17"></a><a class="code" href="structM75__SCC__REGS__PB.html#o14">wr15</a> );

    <span class="keywordflow">return</span>( path );

ABORT:
    <span class="keywordflow">if</span> (M_close(path) &lt; 0)
        <a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="stringliteral">"close dev"</span>);
    <span class="keywordflow">return</span>( -1 );

} <span class="comment">/* setupChannel */</span>
<span class="comment">/********************************* PrintError ******************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="m75__simp_8c.html#a2">PrintError</a>(<span class="keywordtype">char</span> *info)
{
    printf(<span class="stringliteral">"*** can't %s: %s\n"</span>, info, M_errstring(UOS_ErrnoGet()));
}


</pre></div> 
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for M75 MDIS Driver using <a href="http://www.doxygen.org">doxygen</a>.<br>
	Copyright &copy; 2008 <a href="http://www.men.de">MEN Mikro Elektronik GmbH</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>
